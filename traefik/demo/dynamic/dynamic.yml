http:
  routers:

    frontend:
      entryPoints: [websecure]
      rule: "Host(`demo.vinas.lt`)"
      service: frontend@docker
      priority: 10
      tls:
        certResolver: letsencrypt

    api:
      entryPoints: [websecure]
      rule: "Host(`api.vinas.lt`) && PathPrefix(`/auction-api`)"
      service: api-service
      priority: 100
      middlewares: [cors, api-strip]
      tls:
        certResolver: letsencrypt

    payment-webhook:
      entryPoints: [websecure]
      rule: "Host(`api.vinas.lt`) && Path(`/payment/public/stripe/webhook`)"
      service: payment
      priority: 200  # Stripe webhook requires highest precedence
      middlewares: [payment-strip, cors]
      tls:
        certResolver: letsencrypt

    payment-public:
      entryPoints: [websecure]
      rule: "Host(`api.vinas.lt`) && (Path(`/payment/docs`) || PathPrefix(`/payment/docs/`) || Path(`/payment/openapi.json`))"
      service: payment
      priority: 190
      middlewares: [payment-strip, cors]
      tls:
        certResolver: letsencrypt

    payment-protected:
      entryPoints: [websecure]
      rule: "Host(`api.vinas.lt`) && PathPrefix(`/payment/private`)"
      service: payment
      priority: 50
      middlewares: [auth-forward, payment-strip, cors]
      tls:
        certResolver: letsencrypt

    calculator:
      entryPoints: [websecure]
      rule: "Host(`api.vinas.lt`) && PathPrefix(`/calculator`)"
      service: calculator
      priority: 45
      middlewares: [calculator-strip, cors]
      tls:
        certResolver: letsencrypt

    # Other services
    grafana:
      entryPoints: [websecure]
      rule: "Host(`api.vinas.lt`) && PathPrefix(`/grafana`)"
      service: grafana
      priority: 100
      tls:
        certResolver: letsencrypt

    adminer:
      entryPoints: [websecure]
      rule: "Host(`api.vinas.lt`) && PathPrefix(`/adminer`)"
      service: adminer
      priority: 95
      middlewares: [adminer-strip, cors]
      tls:
        certResolver: letsencrypt

    notification:
      entryPoints: [websecure]
      rule: "Host(`api.vinas.lt`) && PathPrefix(`/notification`)"
      service: notification
      priority: 90
      middlewares: [notification-strip, cors]
      tls:
        certResolver: letsencrypt

    auth:
      entryPoints: [websecure]
      rule: "Host(`api.vinas.lt`) && PathPrefix(`/auth`)"
      service: auth
      priority: 80
      middlewares: [auth-strip, cors]
      tls:
        certResolver: letsencrypt

  services:

    api-service:
      loadBalancer:
        servers:
          - url: "http://api_service:8000"

    auth:
      loadBalancer:
        servers:
          - url: "http://auth_service:8003"

    calculator:
      loadBalancer:
        servers:
          - url: "http://calculator_service:8005"

    payment:
      loadBalancer:
        servers:
          - url: "http://payment_service:8002"

    notification:
      loadBalancer:
        servers:
          - url: "http://notification_service:8004"

    grafana:
      loadBalancer:
        servers:
          - url: "http://grafana:3000"

    adminer:
      loadBalancer:
        servers:
          - url: "http://database_adminer:8080"

  middlewares:
    # Strip prefix middlewares

    api-strip:
      stripPrefix:
        prefixes: [ "/auction-api" ]

    calculator-strip:
      stripPrefix:
        prefixes: [ "/calculator" ]

    auth-strip:
      stripPrefix:
        prefixes: [ "/auth" ]


    payment-strip:
      stripPrefix:
        prefixes: ["/payment"]

    notification-strip:
      stripPrefix:
        prefixes: ["/notification"]

    rabbitmq-strip:
      stripPrefix:
        prefixes: ["/rabbitmq"]

    adminer-strip:
      stripPrefix:
        prefixes: ["/adminer"]

    cors:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        accessControlAllowOriginList:
          - "*"
        accessControlAllowHeaders:
          - "Content-Type"
          - "Authorization"
          - "X-Requested-With"
        accessControlExposeHeaders:
          - "X-Total-Count"
        accessControlAllowCredentials: true
        accessControlMaxAge: 86400

    # Auth forward middleware
    auth-forward:
      forwardAuth:
        address: "http://auth_service:8003/v1/verify"
        trustForwardHeader: true
        authRequestHeaders:
          - Authorization
          - Cookie
          - X-Forwarded-Method
          - X-Forwarded-Host
          - X-Forwarded-Uri
        authResponseHeaders:
          - X-User-ID
          - X-User-Email
          - X-User-Role
          - X-Token-Expires
          - X-Permissions
